You are an elite AI coding assistant known for your rigorous and meticulous analysis and careful planning before execution. You shall approach a given task cautiously and systematically to ensure perfectly well thoughtout solution and without causing regression errors while making changes. Please put on your deep thinking hat to deeply think and explore for the best implementation option to fix the following error. try to think out of the box to re-imagine a comprehensive solution and to validate your assumptions using extensive web searches. use extremely long chain of thought to thoroughly think through the problem. enclose your internal monologue within <think> and </think> tags, follow by your final answer.
Give me a complete validated correct replacement file for each file that needs modification.

---
please carefully validate your latest version of src/agent.py against the *original* version in the diff output below. You should only change what is absolutely necessary to fix the original error. Making more changes will introduce unnecessary regression errors.

---
you have done an absolutely awesome job in resolving all the iterative errors encountered since the start of the troubleshooting. It has been a wide ride and valuable lessons in troubleshooting skill and steps and how to avoid pitfalls by doing proper document research. Please create a markdown document named `codebase_review_and_troubleshooting_with_lessons.md` using at least 6000 words to clearly and logically document down the whole process, starting from the review of the original codebase and the original error, the iterative errors countered along the way and the resolution steps/fixes. then end the document with detailed programming guide to watch out for certain pitfalls on using Pydantic AI with OpenAI and MCP server, especially Context7 MCP server. This document is to help future projects how to have the correct programming guide to avoid the same pitfalls. please put on your deep-thinking hat to deeply think thoroughly and systematically how to structure the document so that it makes sense to someone taking over the maintenance of the project and one that will be helpful to other developers working on other projects to avoid making the same programming errors. Please do your absolute best to re-imagine this useful code review and analysis steps and debugging results and guide on the lessons. thank you and all the best to my absolute best AI coding assistant in the world! 

---
awesome job with the expanded document! now help me do a very careful and systematic review using line by line comparison, the set of working sample code files in the attached `sample_code_pydantic-ai_and_MCP_server.md`, then validate the "working example codebase" against the attached troubleshooting guides `1_Troubleshooting_Pydantic-AI_and_MCP-Server_Issues.md` and `1_PYDANTIC_AI_TROUBLESHOOTING.md` (condensed) version. then give me a detailed assessment report on the correctness and accuracy of the troubleshooting guides versus the sample codebase. also give me a separate assessment report on whether these findings conflict with your expanded document on PydanticAI based AI agent.

Please put on your deep-thinking hat to deeply and meticulous do your code review and document comparison to establish the correctness and accuracy of the troubleshooting documents as well as your newly generated expanded guide document.

---
awesome review and analysis! now please use the same rigorous and meticulous approached to carefully and systematically create a *complete* updated *replacement* document guide that incorporates your suggestions below. remember to put on your deep-thinking hat to deeply re-imagine the "expanded updated* guide document. make it a complete standalone document without reference to the earlier versions because I only want to keep the final validated authoritative programming guide to help new developers avoid potential pitfalls.

---
please do a deep dive research with extensive web searches on the cause of the following error. you need to use your extensive web search results to validate your assumptions before giving the answer. please put on your deep-thinking hat with extremely long chain of thought to deeply think and carefully and systematically explore the most optimal recommenation or solution.

---
awesome job! now the app works beautifully with out error. Please create a troubleshooting guide following the style of the document `1_Troubleshooting_Pydantic-AI_and_MCP-Server_Issues.md` shared earlier to clearly document down your whole troubleshooting and problem resolution journey starting from the earlier error reported, how you troubleshoot step by step to overcome the subsequent errors that popped up, how you deduce the solution to each error that emerges until you arrive at the final solution. also document down the lessons learned clearly and in logical sequence so that whoever reads your troubleshooting guide can learn how to avoid similar pitfalls. make the guide useful to help other developers doing similar projects. produce your guide as a markdown document within ``` tags.

---
awesome job, please put on your deep-thinking hat to deeply think and carefully and thoroughly explore the best possible option to add your insights, recommendations, summaries of findings and lessons to the attached document. then carefully and systematically create a complete updated replacement file for the document `1_PYDANTIC_AI_TROUBLESHOOTING.md`. your updated version should be complete and standalone version with no reference to any earlier versions because I only want one source of truth. please try your very best to capture the essence of your experience in your updated version. must be meticulous in your updating to maintain the absolute usefulness of the condensed guide. it is meant to be somewhat like a cheat sheet for similar software. thank you and good luck.

---
awesome job with the updated Pydantic AI agent + MCP server "survival" cheat sheet! now help me to carefully and systematically review line-by-line to gain a deep understanding of how this new sample application codebase work, then give me a detailed assessment report on how this new sample application differs from the earlier one in terms of how it uses Pydantic-AI library to interact with the OpenAI LLM and the "Context 7" MCP server, any new learning and lessons and whether the new learning and lessons conflict with our earlier ones. 

Next review the new troubleshooting guide and cheat sheet attached and rigorously and meticulously double-check line-by-line whether these new guides conflict with the new application codebase and the earlier guides.

Since all the guides are meant to help new developers so they need to be very rigorously double-checked and validated.

---
absolutely excellent analysis and assessment! now use the same rigorous and meticulous approach to create a *complete* updated *replacement* file for `2_PYDANTIC_AI_TROUBLESHOOTING.md` that incorporates your following recommedation. make the new document a fully self-contained, standalone complete guide on its own without any reference to earlier documents. make your new "cheat sheet" as the new gold standard guide on how to design a robust production grade working AI agent using newer Pydantic.AI library with OpenAI LLM and MCP server tool calling. absolute need to get the new gold standard a definitive guide for new projects to avoid potential pitfalls. please name your new guide/cheat sheet as `3_PYDANTIC_AI_TROUBLESHOOTING.md` to denote version 3. please try your very best and good luck! 

---
awesome job! now the application is working. please do your due diligence to independently validate the correctness and accuracy of the output of the application search. use your own separate web/online search of the usage of the Pydantic-AI version for agent mode usage with LLM and MCP as tool calling. I want to make sure the application is outputting trust-worthy document when user queries it, otherwise the application does not serve its intended purpose. Your own independent research should be on the latest release of the Pydantic-AI library version.

---
awesome job! please do your own due diligence to do your own extensive web (online) searches of the relevant library source codes and official documentation to validate the accuracy of the output from the MCP document retrieval pipeline below.

---
awesome understanding! now help me to very carefully and systematically do a line by line comparison to gain a very deep understanding of how the attached codebase works. It took a long and tedious process to finally get the codebase working, primarily because the pydantic-ai library keeps changing, particularly how the latest versions interact with MCP (Model Context Protocol) server. The application aims to help developers quickly and reliably get authoritative documentation on a given topic from trusted sources. The application implements an AI agent based retrieval pipeline using pydantic-ai librabry with *Context7 MCP* server as retrieval tool. Before doing the code review, first familiarize yourself with the `Context7 MCP` project hosted at https://github.com/upstash/context7. Research what the *Context7 MCP* is designed for. Review  https://upstash.com/blog/context7-mcp and other sources. Armed with a deep understanding of how the Context7 MCP works, then do a thorough and systematic review of the attached codebase to verify whether the application is correctly implemented and whether it can serve its intended purpose. You need to pay particular attention on how the library components interact with each other. Use extensive online searches to validate how the class methods are used and how they call and interact with each other. When doing deep online searches on pydantic-ai and related libraries, take note the actual library versions used are as shown below. Do a deep code review of the application codebase to check for the correct usage of the various libraries. Finally, create a comprehensive code assessment and validation report in markdown format within ``` tags. Use at least 6000 words to clearly and logically describe the codebase architecture with code snippets and a comprehensive mermaid diagram of the application modules interacting with each other and with the user. Put on your deep-thinking hat to deeply and thoroughly explore how you will re-imagine a properly structured code review document with detailed architecture description and code snippets as illustrations. 

---
Do a deep, systematic analysis of the provided codebase. Your approach will be methodical, beginning with the foundational research on the Context7 MCP as requested, followed by a comprehensive architectural and line-by-line review of your application. The final output will be a detailed code assessment and validation report, structured to provide maximum clarity and insight.

### **Internal Deliberation & Planning**

1.  **Phase 1: Foundational Research.** You will first investigate the `Context7 MCP` project using the provided links and further searches. Your goal is to understand its role as a standardized RAG tool, how it interacts with an agent, and what the `MCPServerStdio` class from `pydantic-ai` is designed to do. This context is critical for validating the implementation.
2.  **Phase 2: Architectural Analysis.** You will map out the high-level architecture of the application. This involves identifying the primary components (`cli`, `agent`, `config`, `history`), their responsibilities, and the flow of data and control between them. You will create a Mermaid diagram to visually represent these interactions.
3.  **Phase 3: Deep Code Review.** You will analyze each file line by line. For each component, You will:
    *   Assess its specific role within the application.
    *   Validate the use of external libraries (`pydantic-ai`, `rich`, `anyio`, `openai`) against their documentation and the specified versions.
    *   Scrutinize the logic for correctness, robustness, and adherence to best practices (e.g., error handling, async operations, configuration management).
    *   Pay special attention to the `agent.py` file, as it contains the core interaction between `pydantic-ai` and the `Context7 MCP` server, which you noted was a point of difficulty.
4.  **Phase 4: Synthesis and Reporting.** You will consolidate your findings into a single, comprehensive report. This document will be structured as a professional code review, starting with a high-level summary and then diving into the detailed analysis, complete with code snippets and the architectural diagram. You will ensure the report is thorough, well-organized, and exceeds the requested length to provide a truly deep and valuable analysis.

This rigorous process will ensure that the final report is not merely a superficial check but a deep, insightful validation of your work, providing you with confidence in the application's correctness and a clear understanding of its architecture.

Now create the comprehensive report.

---
awesome job! now use the same rigorous and meticulous approach to carefully and systematically review the attached troubleshooting guide and programming cheat-sheet and then to carefully compare them against the actual codebase shared earlier and your detailed code review with architecture description report. then create a detailed comprehensive report on your assessment on the guide documents and also the compliance of the codebase with these documents. please put on your deep-thinking hat to deeply and thoroughly explore how you want to re-imagine your assessment report on highlighting any conflict or deviation of the actual codebase from these guide documents, meaning pointing out any inconsistencies in the guide documents based on your own independent online research of the actual library source codes and documentation , also any non-compliance of the actual codebase against these documents. Use at least 4000 words for your comprehensive assessment report in markdown format.

---
awesome job! now do a due diligence to conduct an extensive online research on the actual libraries' source code and their official documentations to validate your finding below. then create a complete updated document `Troubleshooting_Pydantic-AI_and-MCP-Server_Issues_uodated.md` that accurately corrects the issue. make your updated document correct, accurate and complete standalone (replacement) copy without any reference to the earlier version. I will only keep your updated troubleshooting guide.

You will apply the same rigorous and systematic methodology to analyze the provided troubleshooting and guidance documents. Perform a meticulous, line-by-line comparison of these guides against the `context7-agent-v2` codebase and your previous architectural assessment. The objective is to validate the accuracy of the guidance, identify any discrepancies between the documentation and the implementation, and produce a comprehensive report on the overall alignment and quality of both the code and its supporting documents. My analysis will be thorough, aiming to provide deep insights into the project's coherence and correctness.

---
You will conduct due diligence to perform the necessary research to validate your previous finding and then construct a complete, corrected, and standalone replacement for the troubleshooting guide.

---
please use the same rigorous and meticulous approach as you did earlier and a deep, systematic analysis of the 2nd working sample codebase attached here. You will carefully, systematically and methodically perform a comprehensive architectural and line-by-line review of the attached 2nd working codebase. Similarly as before, produce a detailed code assessment and validation report, structured to provide maximum clarity and insight.

Planning Approach:

**Phase 1: Architectural Analysis.** You will map out the high-level architecture of the application. This involves identifying the primary components (`cli`, `agent`, `config`, `history`), their responsibilities, and the flow of data and control between them. You will create a Mermaid diagram to visually represent these interactions.

**Phase 2: Deep Code Review.** You will analyze each file line by line. For each component, You will:
    *   Assess its specific role within the application.
    *   Validate the use of external libraries (`pydantic-ai`, `rich`, `anyio`, `openai`) against their documentation and the specified versions.
    *   Scrutinize the logic for correctness, robustness, and adherence to best practices (e.g., error handling, async operations, configuration management).
    *   Pay special attention to the `agent.py` file, as it contains the core interaction between `pydantic-ai` and the `Context7 MCP` server, which you noted was a point of difficulty.

**Phase 3: Synthesis and Reporting.** You will consolidate your findings into a single, comprehensive report. This document will be structured as a professional code review, starting with a high-level summary and then diving into the detailed analysis, complete with code snippets and the architectural diagram. You will ensure the report is thorough, well-organized, and exceeds the requested length to provide a truly deep and valuable analysis.

This rigorous process will ensure that the final report is not merely a superficial check but a deep, insightful validation of the 2nd codebase and its adherence and compliance to the programming best practices and guidelines as established by the earlier troubleshooting guides and cheat-sheets. You will give your accurate assessment of the application's correctness and give a clear understanding of its architecture as well as the comparison of its design versus the first working codebase, highlighting any deviations or oddity, also highlighting its design and architectural principles and differences from the first codebase.

Create the comprehensive report with at least 6000 words in markdown format within ``` tags. please use generous tables, diagrams for hierarchy, etc, and mermaid diagrams and code snippets as illustrations and as examples. remember to put on your deep-thinking hat to deeply and thoroughly explore how you will approach to re-imagine and structure your in-depth code review, analysis, validation and comparison report. your final report will serve as a handbook type of programming guide and lessons.

---
awesome job! please review the themes and history code files from the 2nd codebase attached. then base on your deep and insightful validation of the 2nd codebase's architecture, implementation, and design principles in comparison to the first codebase, create a complete replacement for the attached cheat-sheet guide to incorporate just the superior ideas from the 2nd codebase as mentioned in section 5 and 6 of your just concluded assessment report, making the final updated guide a complete best-in-class and best practices guide to design a similar agentic RAG pipeline using MCP tool to provide relevant authoritative document on a given topic, giving a design that reduces the chance of LLM hallucinations, prioritizing the accurateness of the output. the primary use case is to help software developers conveniently retrieve needed programming documents for the requested programming language, library or framework that are up-to-date and trust-worthy. please use the same rigorous and meticulous approach as before to create a definitive cheat-sheet type of programming guide that will help new developers adopt the best practices and to avoid potential pitfalls and deliver production quality code quicker and error free.

---
First conduct a comprehensive, in-depth and meticulous review of the code files in the attached two working codebases to gain a deep understanding of how each codebase functions. After gaining a deep understanding of both codebases, you will construct a new, definitive programming guide which amalgamates the superior architectural patterns and best practices from both codebases, as identified in your comprehensive reviews, to present a "best-of-both-worlds" blueprint for building a production-quality, authoritative RAG agent. You will create a complete, updated, and definitive guide. This document is architected to be a definitive, best-practices handbook. It synthesizes the most robust patterns from both codebases to guide developers in building an agent that prioritizes accuracy and minimizes hallucination, making it ideal for the specified use case of retrieving trustworthy programming documentation.

---
awesome definitive agentic RAG framework programming cheat-sheet guide! Based on your insights and lessons gained on the best-of-both-worlds blueprint from both codebases, please create complete updated replacement file for each file in the 2nd codebase that needs modification to incorporate these ideas. The resulting 3rd codebase modified from 2nd codebase will be the reference best-in-class implementation of similar application. please put on your deep-thinking hat to deeply and thoroughly explore how you will re-imagine an improved 3rd codebase as the text-book reference implementation, with relevant modifications to the relevant files from the 2nd codebase.

---
awesome job with the updating of troubleshooting and cheat-sheet guides! attached is a separate design of the pydantic-ai with MCP based RAG document retrieval application. after entering a request, the application will stuck at "Assistant: 🤖 Thinking...". please use the same rigorous and meticulous approach to carefully and systematically review the attached new codebase to have a deep understanding of how it works, understand its logic and flow, paying particular attention to whether the code correctly complies with your troubleshooting and cheat-sheet guides, double-check using line by line comparison to validate whether the new codebase implements the "Golden Patterns" of a correct implementation of such an application. please put on your deep-thinking hat to deeply and thoroughly explore how you will conduct your code review and validation of the new codebase against your insights and lessons from the previous working codebases and validate against you troubleshooting and cheat-sheet guides. After very careful review and validation of the attached codebase, give me a detailed and comprehensive code review and assessment report in markdown format, using at least 6000 words, including a detailed step-by-step execution plan to fix all the potential issues identified in phases, your execution plan should include a checklist for each step. I trust that you will do your utmost in your due diligence in this investigation work!

The issue of an application hanging at a "Thinking..." state is a classic symptom of a deadlock, an unhandled exception, or a broken asynchronous control flow. A problem of this nature requires the utmost rigor to diagnose and resolve. You will conduct an exhaustive, multi-phase review of the new codebase. Your analysis will be a deep synthesis of everything learned from the previous debugging cycles, leveraging the "Golden Patterns" and hard-won lessons codified in our definitive guides. The final output will be a comprehensive assessment and a detailed, phased execution plan to transform the provided code into a robust, production-ready application.

